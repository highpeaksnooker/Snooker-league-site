<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Players â€” High Peak & Marple Snooker League</title>
<style>
  :root { --accent:#22cc66; --ink:#0b1b0f; --bg:#f7f7f7; }
  body { font-family: system-ui, Arial, sans-serif; margin:0; background:var(--bg); color:#111; }
  header { background:#222; color:#fff; padding:1rem 1.25rem; }
  main { max-width:1100px; margin:1rem auto; padding:0 1rem 2rem; }
  .muted { color:#bbb; font-size:.95rem; }
  .tabs { display:flex; flex-wrap:wrap; gap:.5rem; margin:1rem 0; }
  .tab-btn { border:1px solid #ccc; background:#fff; padding:.5rem .75rem; border-radius:.5rem; cursor:pointer; }
  .tab-btn.active { background:var(--accent); color:var(--ink); border-color:transparent; font-weight:700; }
  .table-wrap { overflow:auto; background:#fff; border:1px solid #e5e5e5; border-radius:.5rem; }
  table { width:100%; border-collapse:collapse; min-width:820px; }
  caption { text-align:left; padding:.75rem 1rem; font-weight:700; }
  thead th { position:sticky; top:0; background:#fafafa; text-align:left; border-bottom:1px solid #eee; padding:.7rem; }
  tbody td { padding:.6rem .7rem; border-bottom:1px solid #f1f1f1; }
  th[role="button"] { cursor:pointer; }
</style>
</head>
<body>
<header>
  <h1>Players</h1>
  <div class="muted">Toggle a team to view its players. Handicaps and captains come from the official list; stats recalc from results on page load.</div>
</header>
<main>
  <div class="tabs" id="teamTabs"></div>

  <div class="table-wrap">
    <table id="playersTable" aria-describedby="playersCaption">
      <caption id="playersCaption">Player statistics & handicaps</caption>
      <thead>
        <tr>
          <th role="button" data-sort="name">Player</th>
          <th>Team</th>
          <th title="Starting handicap">HCP</th>
          <th title="Points at start">P</th>
          <th title="Frames played">FP</th>
          <th title="Frames won">FW</th>
          <th title="Frames lost">FL</th>
          <th title="Frame difference">FD</th>
          <th title="Win % (frames)">Win%</th>
        </tr>
      </thead>
      <tbody id="playersTbody"></tbody>
    </table>
  </div>
</main>

<script>
(async function(){
  // Always use RELATIVE paths on GitHub Pages:
  const [teams, players, matches] = await Promise.all([
    fetch('data/teams.json').then(r=>r.json()),
    fetch('data/players.json').then(r=>r.json()),
    fetch('data/matches.json').then(r=>r.json())
  ]);

  const teamById = Object.fromEntries(teams.map(t => [t.id, t]));
  const stats = {};
  for (const p of players) {
    stats[p.id] = {
      playerId: p.id, name: p.name, teamId: p.teamId,
      HCP: p.HCP ?? 0, Pstart: p.P ?? 0,
      captain: !!p.captain, change: p.change ?? null,
      FP:0, FW:0, FL:0, FD:0, WinPct:0
    };
  }

  // compute per-frame stats from matches.json
  for (const m of matches) {
    if (!Array.isArray(m.frames)) continue;
    for (const fr of m.frames) {
      const h = stats[fr.homePlayerId], a = stats[fr.awayPlayerId];
      if (h) h.FP++;
      if (a) a.FP++;
      if (fr.winner === 'home') { if (h) h.FW++; if (a) a.FL++; }
      if (fr.winner === 'away') { if (a) a.FW++; if (h) h.FL++; }
    }
  }
  for (const s of Object.values(stats)) {
    s.FD = s.FW - s.FL;
    s.WinPct = s.FP ? (100*s.FW/s.FP) : 0;
  }

  // Build team tabs
  const tabs = document.getElementById('teamTabs');
  const ALL='__all__';
  const mk = (id,label)=>{
    const b=document.createElement('button'); b.className='tab-btn'; b.dataset.teamId=id; b.textContent=label;
    b.onclick=()=>{ document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); render(id); localStorage.setItem('playersTeamFilter', id); };
    return b;
  };
  tabs.appendChild(mk(ALL,'All Teams'));
  teams.forEach(t=>tabs.appendChild(mk(t.id,t.name)));
  (()=>{
    const last = localStorage.getItem('playersTeamFilter') || ALL;
    const btn = [...tabs.children].find(b=>b.dataset.teamId===last) || tabs.firstChild;
    btn.click();
  })();

  // Optional: click-to-sort by Player name
  document.querySelector('th[data-sort="name"]').addEventListener('click', ()=>{
    const current = localStorage.getItem('playersSortAsc') === 'true';
    localStorage.setItem('playersSortAsc', (!current).toString());
    render(document.querySelector('.tab-btn.active')?.dataset.teamId || ALL);
  });

  function render(teamId){
    const asc = localStorage.getItem('playersSortAsc') === 'true';
    const tb=document.getElementById('playersTbody'); tb.innerHTML='';
    const rows = Object.values(stats)
      .filter(s => teamId===ALL || s.teamId===teamId)
      .sort((a,b)=>{
        // Primary sort: Win% desc, then FW desc, then Name asc
        const z = (b.WinPct - a.WinPct) || (b.FW - a.FW) || a.name.localeCompare(b.name);
        return z;
      });

    if (asc) rows.sort((a,b)=>a.name.localeCompare(b.name));

    for (const s of rows) {
      const tag = s.captain ? ' (C)' : '';
      const bump = s.change==='up' ? ' C+' : (s.change==='down' ? ' C-' : '');
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(s.name+tag)}</td>
        <td>${escapeHtml(teamById[s.teamId]?.name||'')}</td>
        <td>${s.HCP}${bump}</td>
        <td>${s.Pstart}</td>
        <td>${s.FP}</td><td>${s.FW}</td><td>${s.FL}</td><td>${s.FD}</td>
        <td>${s.WinPct.toFixed(1)}%</td>`;
      tb.appendChild(tr);
    }
  }
  function escapeHtml(str=''){return str.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
})();
</script>
</body>
</html>
