<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Players — High Peak & Marple Snooker League</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header>
    <h1>High Peak &amp; Marple Snooker League</h1>
  </header>

  <!-- ✅ Announcement Banner -->
  <div id="announcement-banner"><span id="announcement-text"></span></div>

  <!-- ✅ Main Navigation -->
  <nav>
    <a href="index.html">Home</a>
    <a href="history.html">History</a>
    <a href="league.html">League Table</a>
    <a href="fixtures.html">Fixtures</a>
    <a href="results.html">Results</a>
    <a href="players.html" class="active">Players</a>
    <a href="venues.html">Venues</a>
    <a href="rules.html">Rules</a>
    <a href="merit.html">Merit</a>
  </nav>

  <main>
    <h2>Players</h2>
    <p>Toggle a team to view its players. Handicaps and captains come from the official list; stats recalc from results on page load.</p>

    <div class="tabs" id="teamTabs"></div>

    <div class="table-wrap">
      <table id="playersTable" aria-describedby="playersCaption">
        <caption id="playersCaption">Player statistics & handicaps</caption>
        <thead>
          <tr>
            <th role="button" data-sort="name">Player</th>
            <th>Team</th>
            <th title="Starting handicap">HCP</th>
            <th title="Points at start">P</th>
            <th title="Frames played">FP</th>
            <th title="Frames won">FW</th>
            <th title="Frames lost">FL</th>
            <th title="Frame difference">FD</th>
            <th title="Win % (frames)">Win%</th>
          </tr>
        </thead>
        <tbody id="playersTbody"></tbody>
      </table>
    </div>
  </main>

  <footer>&copy; 2025 High Peak &amp; Marple Snooker League</footer>

  <!-- ✅ Banner Script -->
  <script>
    fetch('data/announcement.json')
      .then(response => response.json())
      .then(data => {
        if (data.message && data.message.trim()) {
          const banner = document.getElementById('announcement-banner');
          const text = document.getElementById('announcement-text');
          text.textContent = data.message;
          banner.style.display = 'block';
        }
      })
      .catch(err => {
        console.warn('Announcement could not be loaded:', err);
      });
  </script>

  <!-- ✅ Players Script -->
  <script>
  (async function(){
    const [teams, players, matches] = await Promise.all([
      fetch('data/teams.json').then(r=>r.json()),
      fetch('data/players.json').then(r=>r.json()),
      fetch('data/matches.json').then(r=>r.json())
    ]);

    const teamById = Object.fromEntries(teams.map(t => [t.id, t]));
    const stats = {};
    for (const p of players) {
      stats[p.id] = {
        playerId: p.id, name: p.name, teamId: p.teamId,
        HCP: p.HCP ?? 0, Pstart: p.P ?? 0,
        captain: !!p.captain, change: p.change ?? null,
        FP:0, FW:0, FL:0, FD:0, WinPct:0
      };
    }

    for (const m of matches) {
      if (!Array.isArray(m.frames)) continue;
      for (const fr of m.frames) {
        const h = stats[fr.homePlayerId], a = stats[fr.awayPlayerId];
        if (h) h.FP++;
        if (a) a.FP++;
        if (fr.winner === 'home') { if (h) h.FW++; if (a) a.FL++; }
        if (fr.winner === 'away') { if (a) a.FW++; if (h) h.FL++; }
      }
    }

    for (const s of Object.values(stats)) {
      s.FD = s.FW - s.FL;
      s.WinPct = s.FP ? (100 * s.FW / s.FP) : 0;
    }

    const tabs = document.getElementById('teamTabs');
    const ALL = '__all__';
    const mk = (id, label) => {
      const b = document.createElement('button');
      b.className = 'tab-btn';
      b.dataset.teamId = id;
      b.textContent = label;
      b.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        render(id);
        localStorage.setItem('playersTeamFilter', id);
      };
      return b;
    };
    tabs.appendChild(mk(ALL, 'All Teams'));
    teams.forEach(t => tabs.appendChild(mk(t.id, t.name)));
    (() => {
      const last = localStorage.getItem('playersTeamFilter') || ALL;
      const btn = [...tabs.children].find(b => b.dataset.teamId === last) || tabs.firstChild;
      btn.click();
    })();

    document.querySelector('th[data-sort="name"]').addEventListener('click', () => {
      const current = localStorage.getItem('playersSortAsc') === 'true';
      localStorage.setItem('playersSortAsc', (!current).toString());
      render(document.querySelector('.tab-btn.active')?.dataset.teamId || ALL);
    });

    function render(teamId) {
      const asc = localStorage.getItem('playersSortAsc') === 'true';
      const tb = document.getElementById('playersTbody');
      tb.innerHTML = '';
      const rows = Object.values(stats)
        .filter(s => teamId === ALL || s.teamId === teamId)
        .sort((a, b) => {
          const z = (b.WinPct - a.WinPct) || (b.FW - a.FW) || a.name.localeCompare(b.name);
          return z;
        });
      if (asc) rows.sort((a, b) => a.name.localeCompare(b.name));

      for (const s of rows) {
        const tag = s.captain ? ' (C)' : '';
        const bump = s.change === 'up' ? ' C+' : (s.change === 'down' ? ' C-' : '');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(s.name + tag)}</td>
          <td>${escapeHtml(teamById[s.teamId]?.name || '')}</td>
          <td>${s.HCP}${bump}</td>
          <td>${s.Pstart}</td>
          <td>${s.FP}</td><td>${s.FW}</td><td>${s.FL}</td><td>${s.FD}</td>
          <td>${s.WinPct.toFixed(1)}%</td>`;
        tb.appendChild(tr);
      }
    }

    function escapeHtml(str = '') {
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }
  })();
  </script>
</body>
</html>
