<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Players — High Peak & Marple Snooker League</title>

  <!-- ✅ All styles live in the <head> -->
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7f7f7; color:#111; }

    /* Page header bar (nav background wrapper) */
    .page-header { background:#222; color:#fff; }

    /* Navigation bar */
    .site-nav { display:flex; flex-wrap:wrap; gap:.25rem; background:#444; padding:.6rem .8rem; justify-content:center; }
    .site-nav a { color:#fff; text-decoration:none; padding:.45rem .6rem; border-radius:.35rem; }
    .site-nav a:hover { background:#555; }
    .site-nav a.active { background:#22cc66; color:#0b1b0f; font-weight:700; }

    /* Page main content */
    main { max-width:1100px; margin:1rem auto; padding:0 1rem 2rem; }

    /* Tabs for teams */
    .tabs { display:flex; flex-wrap:wrap; gap:.5rem; margin:1rem 0; }
    .tab-btn { border:1px solid #ccc; background:#fff; padding:.5rem .75rem; border-radius:.5rem; cursor:pointer; }
    .tab-btn.active { background:#22cc66; color:#0b1b0f; border-color:transparent; font-weight:700; }

    /* Players table */
    .table-wrap { overflow:auto; background:#fff; border:1px solid #e5e5e5; border-radius:.5rem; }
    table { width:100%; border-collapse:collapse; min-width:820px; }
    caption { text-align:left; padding:.75rem 1rem; font-weight:700; }
    thead th { position:sticky; top:0; background:#fafafa; text-align:left; border-bottom:1px solid #eee; padding:.7rem; }
    tbody td { padding:.6rem .7rem; border-bottom:1px solid #f1f1f1; }
    th[role="button"] { cursor:pointer; }
  </style>
</head>
<body>

  <!-- ✅ Nav bar goes right after <body> -->
  <header class="page-header">
    <nav class="site-nav" id="mainNav">
      <a href="/index.html">Home</a>
      <a href="/history.html">History</a>
      <a href="/fixtures.html">Fixtures</a>
      <a href="/results.html">Results</a>
      <a href="/players.html">Players</a>
      <a href="/league.html">League Table</a>
      <a href="/venues.html">Venues</a>
      <a href="/rules.html">Rules</a>
    </nav>
  </header>

  <!-- ✅ Main page content -->
  <main>
    <h1>Players</h1>
    <p>Toggle a team to view its players. Handicaps and captains come from the official list; stats recalc from results on page load.</p>

    <div class="tabs" id="teamTabs"></div>

    <div class="table-wrap">
      <table id="playersTable" aria-describedby="playersCaption">
        <caption id="playersCaption">Player statistics & handicaps</caption>
        <thead>
          <tr>
            <th role="button" data-sort="name">Player</th>
            <th>Team</th>
            <th title="Starting handicap">HCP</th>
            <th title="Points at start">P</th>
            <th title="Frames played">FP</th>
            <th title="Frames won">FW</th>
            <th title="Frames lost">FL</th>
            <th title="Frame difference">FD</th>
            <th title="Win % (frames)">Win%</th>
          </tr>
        </thead>
        <tbody id="playersTbody"></tbody>
      </table>
    </div>
  </main>

  <!-- ✅ Scripts always just before </body> -->
  <script>
  // Highlight the current nav link automatically
  (function () {
    var path = location.pathname.replace(/\/+$/, '');
    if (path === '' || path === '/') path = '/index.html';
    document.querySelectorAll('#mainNav a').forEach(function (a) {
      if (a.getAttribute('href') === path) a.classList.add('active');
    });
  })();
  </script>

  <script>
  (async function(){
    const [teams, players, matches] = await Promise.all([
      fetch('data/teams.json').then(r=>r.json()),
      fetch('data/players.json').then(r=>r.json()),
      fetch('data/matches.json').then(r=>r.json())
    ]);

    const teamById = Object.fromEntries(teams.map(t => [t.id, t]));
    const stats = {};
    for (const p of players) {
      stats[p.id] = {
        playerId: p.id, name: p.name, teamId: p.teamId,
        HCP: p.HCP ?? 0, Pstart: p.P ?? 0,
        captain: !!p.captain, change: p.change ?? null,
        FP:0, FW:0, FL:0, FD:0, WinPct:0
      };
    }

    // compute from matches.json
    for (const m of matches) {
      if (!Array.isArray(m.frames)) continue;
      for (const fr of m.frames) {
        const h = stats[fr.homePlayerId], a = stats[fr.awayPlayerId];
        if (h) h.FP++;
        if (a) a.FP++;
        if (fr.winner === 'home') { if (h) h.FW++; if (a) a.FL++; }
        if (fr.winner === 'away') { if (a) a.FW++; if (h) h.FL++; }
      }
    }
    for (const s of Object.values(stats)) {
      s.FD = s.FW - s.FL;
      s.WinPct = s.FP ? (100*s.FW/s.FP) : 0;
    }

    // Build team tabs
    const tabs = document.getElementById('teamTabs');
    const ALL='__all__';
    const mk = (id,label)=>{
      const b=document.createElement('button'); b.className='tab-btn'; b.dataset.teamId=id; b.textContent=label;
      b.onclick=()=>{ document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); render(id); localStorage.setItem('playersTeamFilter', id); };
      return b;
    };
    tabs.appendChild(mk(ALL,'All Teams'));
    teams.forEach(t=>tabs.appendChild(mk(t.id,t.name)));
    (()=>{
      const last = localStorage.getItem('playersTeamFilter') || ALL;
      const btn = [...tabs.children].find(b=>b.dataset.teamId===last) || tabs.firstChild;
      btn.click();
    })();

    // Optional: sort by name
    document.querySelector('th[data-sort="name"]').addEventListener('click', ()=>{
      const current = localStorage.getItem('playersSortAsc') === 'true';
      localStorage.setItem('playersSortAsc', (!current).toString());
      render(document.querySelector('.tab-btn.active')?.dataset.teamId || ALL);
    });

    function render(teamId){
      const asc = localStorage.getItem('playersSortAsc') === 'true';
      const tb=document.getElementById('playersTbody'); tb.innerHTML='';
      const rows = Object.values(stats)
        .filter(s => teamId===ALL || s.teamId===teamId)
        .sort((a,b)=>{
          const z = (b.WinPct - a.WinPct) || (b.FW - a.FW) || a.name.localeCompare(b.name);
          return z;
        });
      if (asc) rows.sort((a,b)=>a.name.localeCompare(b.name));

      for (const s of rows) {
        const tag = s.captain ? ' (C)' : '';
        const bump = s.change==='up' ? ' C+' : (s.change==='down' ? ' C-' : '');
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(s.name+tag)}</td>
          <td>${escapeHtml(teamById[s.teamId]?.name||'')}</td>
          <td>${s.HCP}${bump}</td>
          <td>${s.Pstart}</td>
          <td>${s.FP}</td><td>${s.FW}</td><td>${s.FL}</td><td>${s.FD}</td>
          <td>${s.WinPct.toFixed(1)}%</td>`;
        tb.appendChild(tr);
      }
    }
    function escapeHtml(str=''){return str.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
  })();
  </script>

</body>
</html>
